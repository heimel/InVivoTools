%% Clear
clear

%% CIE HUMAN SCOTOPIC
h2x = [380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780];
h2y = [0.000589 0.000665 0.000752 0.000854 0.000972 0.001108 0.001268 0.001453 0.001668 0.001918 0.002209 0.002547 0.002939 0.003394 0.003921 0.00453 0.00524 0.00605 0.00698 0.00806 0.00929 0.0107 0.01231 0.01413 0.01619 0.01852 0.02113 0.02405 0.0273 0.03089 0.03484 0.03916 0.0439 0.049 0.0545 0.0604 0.0668 0.0736 0.0808 0.0885 0.0966 0.1052 0.1141 0.1235 0.1334 0.1436 0.1541 0.1651 0.1764 0.1879 0.1998 0.2119 0.2243 0.2369 0.2496 0.2625 0.2755 0.2886 0.3017 0.3149 0.3281 0.3412 0.3543 0.3673 0.3803 0.3931 0.406 0.418 0.431 0.443 0.455 0.467 0.479 0.49 0.502 0.513 0.524 0.535 0.546 0.557 0.567 0.578 0.588 0.599 0.61 0.62 0.631 0.642 0.653 0.664 0.676 0.687 0.699 0.71 0.722 0.734 0.745 0.757 0.769 0.781 0.793 0.805 0.817 0.828 0.84 0.851 0.862 0.873 0.884 0.894 0.904 0.914 0.923 0.932 0.941 0.949 0.957 0.964 0.97 0.976 0.982 0.986 0.99 0.994 0.997 0.998 1 1 1 0.998 0.997 0.994 0.99 0.986 0.981 0.975 0.968 0.961 0.953 0.944 0.935 0.925 0.915 0.904 0.892 0.88 0.867 0.854 0.84 0.826 0.811 0.796 0.781 0.765 0.749 0.733 0.717 0.7 0.683 0.667 0.65 0.633 0.616 0.599 0.581 0.564 0.548 0.531 0.514 0.497 0.481 0.465 0.448 0.433 0.417 0.402 0.3864 0.3715 0.3569 0.3427 0.3288 0.3151 0.3018 0.2888 0.2762 0.2639 0.2519 0.2403 0.2291 0.2182 0.2076 0.1974 0.1876 0.1782 0.169 0.1602 0.1517 0.1436 0.1358 0.1284 0.1212 0.1143 0.1078 0.1015 0.0956 0.0899 0.0845 0.0793 0.0745 0.0699 0.0655 0.0613 0.0574 0.0537 0.0502 0.0469 0.0438 0.0409 0.03816 0.03558 0.03315 0.03087 0.02874 0.02674 0.02487 0.02312 0.02147 0.01994 0.01851 0.01718 0.01593 0.01477 0.01369 0.01269 0.01175 0.01088 0.01007 0.00932 0.00862 0.00797 0.00737 0.00682 0.0063 0.00582 0.00538 0.00497 0.00459 0.00424 0.003913 0.003613 0.003335 0.003079 0.002842 0.002623 0.002421 0.002235 0.002062 0.001903 0.001757 0.001621 0.001497 0.001382 0.001276 0.001178 0.001088 0.001005 0.000928 0.000857 0.000792 0.000732 0.000677 0.000626 0.000579 0.000536 0.000496 0.000459 0.000425 0.0003935 0.0003645 0.0003377 0.0003129 0.0002901 0.0002689 0.0002493 0.0002313 0.0002146 0.0001991 0.0001848 0.0001716 0.0001593 0.000148 0.0001375 0.0001277 0.0001187 0.0001104 0.0001026 0.0000954 0.0000888 0.0000826 0.0000769 0.0000715 0.0000666 0.000062 0.0000578 0.0000538 0.0000501 0.0000467 0.0000436 0.0000406 0.00003789 0.00003533 0.00003295 0.00003075 0.0000287 0.00002679 0.00002501 0.00002336 0.00002182 0.00002038 0.00001905 0.0000178 0.00001664 0.00001556 0.00001454 0.0000136 0.00001273 0.00001191 0.00001114 0.00001043 0.00000976 0.00000914 0.00000856 0.00000802 0.00000751 0.00000704 0.0000066 0.00000618 0.0000058 0.00000544 0.0000051 0.00000478 0.00000449 0.00000421 0.000003951 0.000003709 0.000003482 0.00000327 0.00000307 0.000002884 0.00000271 0.000002546 0.000002393 0.00000225 0.000002115 0.000001989 0.00000187 0.000001759 0.000001655 0.000001557 0.000001466 0.000001379 0.000001299 0.000001223 0.000001151 0.000001084 0.000001022 0.000000962 0.000000907 0.000000855 0.000000806 0.00000076 0.000000716 0.000000675 0.000000637 0.000000601 0.000000567 0.000000535 0.000000505 0.000000477 0.00000045 0.000000425 0.000000401 0.000000379 0.000000358 0.0000003382 0.0000003196 0.0000003021 0.0000002855 0.0000002699 0.0000002552 0.0000002413 0.0000002282 0.0000002159 0.0000002042 0.0000001932 0.0000001829 0.0000001731 0.0000001638 0.0000001551 0.0000001468 0.000000139];

%% CIE HUMAN PHOTOTOPIC
h1x = [380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780];
h1y = [0.0002 0.000228 0.000261 0.000299 0.000344 0.000396 0.000455 0.000525 0.000604 0.000696 0.0008 0.000916 0.00105 0.0012 0.00136 0.00155 0.00175 0.00188 0.00223 0.0025 0.0028 0.00312 0.00346 0.00383 0.00423 0.00466 0.00512 0.00562 0.00617 0.00676 0.0074 0.00815 0.00896 0.00983 0.0108 0.0118 0.0128 0.014 0.0151 0.0163 0.0175 0.0186 0.0196 0.0207 0.0217 0.0227 0.0236 0.0246 0.0255 0.0264 0.0273 0.0283 0.0294 0.0304 0.0315 0.0326 0.0337 0.0347 0.0358 0.0369 0.0379 0.0388 0.0398 0.0406 0.0415 0.0424 0.0433 0.0441 0.045 0.0459 0.0468 0.0477 0.0487 0.0498 0.0509 0.0521 0.0534 0.0549 0.0564 0.0581 0.06 0.0626 0.0653 0.068 0.0709 0.0739 0.077 0.0803 0.0837 0.0872 0.091 0.0949 0.099 0.104 0.108 0.113 0.118 0.123 0.128 0.133 0.139 0.145 0.15 0.156 0.163 0.169 0.176 0.184 0.191 0.199 0.208 0.217 0.227 0.237 0.247 0.259 0.27 0.28229 0.29505 0.30857 0.323 0.3384 0.35468 0.37169 0.38928 0.4073 0.42562 0.4443 0.46339 0.48293 0.503 0.52356 0.54451 0.56569 0.58696 0.6082 0.62934 0.6503 0.67087 0.69084 0.71 0.72818 0.74546 0.76196 0.77783 0.7932 0.80811 0.82249 0.8363 0.84949 0.862 0.87381 0.88496 0.89549 0.90544 0.91485 0.92373 0.93209 0.93992 0.94722 0.954 0.96025 0.966 0.97126 0.97602 0.9803 0.98409 0.98748 0.99031 0.99281 0.99495 0.99671 0.99809 0.99911 0.99974 1 0.99985 0.9993 0.99832 0.99689 0.995 0.9926 0.98974 0.98644 0.98272 0.9786 0.97408 0.96917 0.96385 0.95813 0.952 0.94545 0.93849 0.93116 0.92345 0.9154 0.907 0.89827 0.8892 0.87978 0.87 0.85986 0.84939 0.83862 0.82758 0.8163 0.80479 0.79308 0.78119 0.76915 0.757 0.74475 0.73242 0.72 0.70749 0.6949 0.68221 0.66947 0.65674 0.64384 0.631 0.61815 0.60531 0.59247 0.57963 0.5668 0.55396 0.54113 0.52835 0.51563 0.503 0.49046 0.47803 0.46567 0.4534 0.4412 0.42908 0.41703 0.40503 0.39303 0.381 0.36891 0.35682 0.34477 0.33281 0.32 0.30933 0.29785 0.28659 0.27562 0.265 0.25476 0.24488 0.23533 0.22605 0.217 0.20816 0.19954 0.19115 0.18297 0.175 0.16722 0.15964 0.15227 0.14512 0.1382 0.1315 0.12502 0.11877 0.11276 0.107 0.10147 0.0962 0.0911 0.0863 0.0816 0.0771 0.0728 0.0687 0.0648 0.061 0.0574 0.054 0.0507 0.0475 0.0446 0.0418 0.0391 0.0366 0.0342 0.032 0.03 0.0281 0.0263 0.0247 0.0232 0.0218 0.0205 0.0193 0.0181 0.017 0.0159 0.0148 0.0138 0.0128 0.0119 0.0111 0.0103 0.00953 0.00885 0.00821 0.00762 0.00709 0.00659 0.00614 0.00572 0.00534 0.005 0.00468 0.00438 0.0041 0.00384 0.00359 0.00335 0.00313 0.00293 0.00274 0.00256 0.00239 0.00224 0.00209 0.00195 0.00182 0.0017 0.00159 0.00148 0.00138 0.00129 0.0012 0.00112 0.00105 0.000977 0.000911 0.00085 0.000793 0.00074 0.00069 0.000643 0.000599 0.000558 0.00052 0.000484 0.00045 0.000418 0.000389 0.000361 0.000335 0.000311 0.000289 0.000268 0.000249 0.000231 0.000215 0.000199 0.000185 0.000172 0.000151 0.000149 0.000138 0.000129 0.00012 0.000112 0.000104 0.0000973 0.0000908 0.0000848 0.0000791 0.0000739 0.0000689 0.0000643 0.00006 0.000056 0.0000522 0.0000487 0.0000454 0.0000424 0.0000396 0.0000369 0.0000345 0.0000321 0.00003 0.000028 0.0000261 0.0000244 0.0000227 0.0000212 0.0000198 0.0000185 0.0000172 0.0000161 0.000015];

%% MOUSE SENSITIVITY based on Jacobs
m1x = [350.516351118761 366.006884681583 383.562822719449 393.889845094664 421.256454388984 432.616179001721 447.590361445783 492.512908777969 504.905335628227 536.402753872633 552.409638554217 571.514629948365 584.423407917384 612.822719449225 630.378657487091];
m1y = [6.74545454545455 6.79090909090909 6.69090909090909 6.52727272727273 5.61818181818182 5.49090909090909 5.6 5.91818181818182 5.94545454545455 5.87272727272727 5.73636363636364 5.41818181818182 5.14545454545455 4.35454545454545 3.71818181818182];
%m1x = m1x(6:15)
%m1y = m1y(6:15)
m1y = m1y-5.95;%-5.68;
m1y = 10.^m1y;

%% MOUSE SENSITIVITY based on NIKODINGES
m2x = [325.188916876574 338.790931989924 355.415617128464 363.727959697733 379.596977329975 394.710327455919 408.31234256927 435.51637279597 441.561712846348 449.874055415617 468.765743073048 497.481108312343 511.83879093199 529.219143576826 561.712846347607 586.649874055416 614.609571788413];
m2y = [-0.248618784530387 -0.101289134438306 -0.00920810313075507 0 -0.0920810313075506 -0.322283609576427 -0.644567219152855 -1.49171270718232 -1.65745856353591 -1.65745856353591 -1.55616942909761 -1.41804788213628 -1.42725598526704 -1.46408839779006 -1.83241252302026 -2.34806629834254 -3.1767955801105];
m2y = m2y+1.4;%+1.75;
m2y = 10.^m2y;


%% GREEN LUXEON LED PM01
gx = [460.91515729266 480.362249761678 493.231649189704 504.099142040038 506.673021925643 517.826501429933 524.690181124881 524.690181124881 527.836034318398 530.123927550048 531.839847473785 540.705433746425 549.28503336511 550.428979980934 573.593898951382 580.743565300286 611.058150619638 643.088655862726];
gy = [0.00229357798165142 0.0298165137614679 0.107798165137615 0.321100917431193 0.410550458715596 0.802752293577982 0.972477064220183 0.98394495412844 1 0.98394495412844 0.961009174311927 0.731651376146789 0.472477064220184 0.458715596330275 0.13302752293578 0.0940366972477065 0.0160550458715596 0];
gh = interp1(h1x,h1y,gx).*gy;
gm = interp1(m1x,m1y,gx).*gy;

%% BLUE LUXEON LED PM01
bx = [412.011439466158 426.02478551001 430.886558627264 436.034318398475 442.32602478551 446.901811248808 449.76167778837 452.621544327931 454.337464251668 455.195424213537 457.19733079123 457.769304099142 463.775023832221 467.206863679695 480.93422306959 489.513822688275 500.95328884652 506.101048617731 527.264061010486];
by = [0 0.018348623853211 0.0412844036697247 0.0917431192660551 0.201834862385321 0.408256880733945 0.594036697247706 0.807339449541284 0.899082568807339 0.942660550458716 0.979357798165138 1 0.795871559633027 0.596330275229358 0.201834862385321 0.0894495412844036 0.0321100917431193 0.0137614678899083 0];
%bh = interp1(h1x,h1y,bx).*by;
%bm = interp1(m1x,m1y,bx).*by;

%%PLOTS FOR PRESENTATION
bh1 = interp1(h1x,h1y,bx).*by;
bh2 = interp1(h2x,h2y,bx).*by;
bm = interp1(m1x,m1y,bx).*by;
plot(h1x,h1y,'m',h2x,h2y,'k',m1x,m1y,'m:',bx,by,'b--',bx,bh1,'b',bx,bh2,'b',bx,bm,'b:');
legend('Human photopic','Human scotopic','Mouse photopic ~= scotopic','LED BLUE','LED BLUE corrected for human photopic','LED BLUE corrected for human scotopic','LED BLUE corrected for mouse');
xlim([420,700]);



%% CALCULATE ... cd/m2 of 1 internal photodiode (USB device)-5ms unit (ipu)
bh = interp1(h2x,h2y,bx).*by;
bm = interp1(m2x,m2y,bx).*by;
plot(bx,bh,bx,by,h2x,h2y,m1x,m1y,bx,bm);
cval1 = 1/2189; %(W/m2/sr)/(pu/ms) , based on calibration data, (pu = photodiode unit)
cval2 = 1/683; %(W/m2/sr) / (cd/m2)

cval3 = sum((bx(2:end)-bx(1:end-1)).*((by(2:end)+by(1:end-1))/2)); %surface underneath bx-by
cval4 = sum((bx(2:end)-bx(1:end-1)).*((bh(2:end)+bh(1:end-1))/2)); %surface underneath bx-bh
cval5 = cval4/cval3; %blue led spectrum relative to CIE scotopic

cval6 = cval1 / cval2; %(cd/m2) / (pu/ms)  <-->  (cd*ms/m2) / (pu)
cval7 = cval6 * cval5; %correting for blue led characteristics 
fprintf('%10.5f\n',cval7*28000); %multiply with measured pu/ms and there's your candela's per square meter

%internal system however works with pu and we want to see cs*s/m2
cval8 = 1000; %ms/s
cval9 = (cval7/cval8); %(cs*s/m2) / (pu)
fprintf('%10.5f\n',cval9*14); %multiply with pu and there's your candela's times seconds per square meter


%% UV LED
ux = [370 375 380];
uy = [0.001 1 0.001];

%plot(a,b,'r',c,d,'g',linspace(380,780,i),polyval(e,linspace(380,780,i)))
%plot(mx,my,'r',linspace(380,610,i),polyval(mpoly,linspace(380,610,i)),'b')
%plot(m2x,m2y,'m',hx,hy,'r',gx,gy,'g',gx,gm,'g:',bx,by,'b',bx,bm,'b:')
%plot(mx,my,'r',linspace(380,610,i),interp1(mx,my,linspace(380,610,i)),'b')
%plot(m1x,m1y,'w',h1x,h1y,'r',gx,gy,'g',bx,by,'b',gx,gm,'g:',bx,bm,'b:',gx,gh,'g--',bx,bh,'b--')
%plot(m1x,m1y,'w',gx,gy,'g',bx,by,'b',gx,gm,'g:',bx,bm,'b:')


%% PLOT
plot(m1x,m1y,'w',gx,gy,'g',ux,uy,'m',bx,by,'b',h1x,h1y,'w:')
set(gca,'Color',[0,0,0]);

%% Vairate
plot(m1x,m1y,'w',gx,gy,'g',bx,by,'b',gx,gm,'g:',bx,bm,'b:')
set(gca,'Color',[0,0,0]);

wperuG = 2.2645/opp(gx,gy)/5.8
wperuB = 4/opp(bx,by)
MOUSE_GREEN_LED = opp(gx,gm) * wperuG * 683
MOUSE_BLUE_LED = opp(gx,bm) * wperuB * 683


%% Calc
wperu = 2.2645/opp(gx,gy)/5.8;
HUMAN_GREEN_LED = opp(gx,gh) * wperu * 683
MOUSE_GREEN_LED = opp(gx,gm) * wperu * 683;

wperu = 4/opp(bx,by);
HUMAN_BLUE_LED = opp(bx,bh) * wperu * 683
MOUSE_BLUE_LED = opp(bx,bm) * wperu * 683;


%% NOTTIN
%s = size(mx);
%s = s(1,2);
%totx = [];
%toty = [];
%for i = (2:1:s)
%  totx = [totx linspace(mx(i-1),mx(i),10)];
%  toty = [toty linspace(my(i-1),my(i),10)];
%end
%mpoly = polyfit(totx,toty,35);

%by = by * 4/opp(bx,by);
%gy = gy * 2.645/opp(gx,gy);
%LED's mouse adapted
%gm = (polyval(mpoly,gx).*gy);
%bm = (polyval(mpoly,bx).*by);
