function dpnew = editdisplayprefs(dp)

%  Part of the NewStim package
%
%  DPNEW = EDITDISPLAYPREFS(DP)
%
%  Allows one to graphically edit an array of displayprefs objects.  The input
%  DP is expected to be an array of displayprefs objects.  The user is presented
%  with a graphical editor which displays all of the fields of displayprefs and
%  the values presently held by the array.  In the case that all of the elements
%  do not hold the same value, the program will indicate this by the phrase
%  "multiply valued".  The user is allowed to specify values for any of the
%  parameters, and any parameters which were changed will be set the same for
%  the entire array of displayprefs objects.  Any parameters which were not
%  modified, however, will remain the same.  (Thus, it is still possible to
%  change one parameter, such as BGpretime, without affecting other parameters.)
%  Note that changes will not take effect if the "change" box next to the
%  parameter is not checked.  Also note that this will not affect the default
%  displayprefs setting.
%
%  One may also use
%
%  CELLSTR = EDITDISPLAYPREFS([])
%
%  which will allow the user to specify parameters for a new displayprefs
%  object--a cell string describing this object (appropriate for passing to
%  a stimulus object's creator) is returned.
%
%  Questions to vanhoosr@brandeis.edu

outputstr = 0;
dpnew = [];

if isempty(dp),
	outputstr = 1;
	dp = displayprefs({});
end;

g = struct(dp);
if std(cat(1,g.fps))~=0,fpsvstr='multiply valued'; fpsstr = '0';
	else,fpsvstr=num2str(g(1).fps); fpsstr = fpsvstr; end;
if std(cat(1,g.BGpretime))~=0,bgprevstr='multiply valued'; bgprestr='0';
	else,bgprevstr=num2str(g(1).BGpretime); bgprestr = bgprevstr; end;
if std(cat(1,g.BGposttime))~=0,bgpostvstr='multiply valued'; bgpoststr ='0';
	else,bgpostvstr=num2str(g(1).BGposttime); bgpoststr=bgpostvstr; end;
sz = size(cat(1,g.rect)),
if (std(cat(1,g.rect))~=[0 0 0 0])&(sz(1)~=1),
	rectvstr='multiply valued';rectstr='[0 0 0 0]';
	else, rectvstr = mat2str(g(1).rect); rectstr = rectvstr; end;
if std(cat(1,g.roundFrames))~=0, rframevstr='multiply valued'; rframeval=1;
	else,rframevstr=num2str(g(1).roundFrames);rframeval=1+g(1).roundFrames;
	end;
if std(cat(1,g.forceMovie))~=0,forceMovvstr='multiply valued';forceMovval=1;
	else,forceMovvstr=num2str(g(1).forceMovie);
	forceMovval=1+g(1).forceMovie;
	end;

% draw the figure

h0 = figure('Color',[0.8 0.8 0.8], ...
        'PaperPosition',[18 180 576 432], ...
        'PaperUnits','points', ...
        'Position',[366 144 550 310], ...
        'Tag','Fig1', ...
        'ToolBar','none', 'MenuBar','none');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'FontSize',16, ...
        'FontWeight','bold', ...
        'ListboxTop',0, ...
        'Position',[12.8 264.8 240.8 24], ...
        'String','NewStim displayprefs editor', ...
        'Style','text', ...
        'Tag','StaticText1');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 217.6 66.40000000000001 14.4], ...
        'String','fps', ...
        'Style','text', ...
        'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 236.8 67.2 16.8], ...
        'String','parameter:', ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 236.8 125.6 16.8], ...
        'String','current value:', ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 215.2 125.6 16.8], ...
        'String',fpsvstr, ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[246.4 236.8 141.6 16.8], ...
        'String','new value:', ...
        'Style','text', ...
        'Tag','StaticText3');
fpsctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[1 1 1], ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[246.4 212 141.6 20], ...
	'String',fpsstr, ...
        'Style','edit', ...
        'Tag','EditText1');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[20 195.2 66.40000000000001 14.4], ...
        'String','rect', ...
        'Style','text', ...
        'Tag','StaticText2');
rectctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 192.8 125.6 16.8], ...
        'String',rectvstr, ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[1 1 1], ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[246.4 189.6 142.4 20], ...
	'String', rectstr, ...
        'Style','edit', ...
        'Tag','EditText1');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 171.2 67.2 14.4], ...
        'String','depth', ...
        'Style','text', ...
        'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 168.8 125.6 16.8], ...
        'String','8', ...
        'Style','text', ...
        'Tag','StaticText3');
depthctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[246.4 168.8 141.6 16.8], ...
        'String','8', ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 145 65.60000000000001 14.4], ...
        'String','round frames', ...
        'Style','text', ...
        'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 121.2 65.60000000000001 14.4], ...
        'String','force movie', ...
        'Style','text', ...
        'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 97.39999999999999 65.60000000000001 14.4], ...
        'String','BGpretime', ...
        'Style','text', ...
        'Tag','StaticText2');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[19.2 75.2 65.60000000000001 14.4], ...
        'String','BGposttime', ...
        'Style','text', ...
        'Tag','StaticText2');
okctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[62.40000000000001 18.4 66.40000000000001 26.4], ...
        'String','OK', ...
        'Tag','Pushbutton1','UserData',0,...
	'Callback','uiresume(gcbf);set(gcbo,''UserData'',1);');
cancelctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[153.6 18.4 66.40000000000001 26.4], ...
        'String','Cancel', ...
        'Tag','Pushbutton1','UserData',0,...
	'Callback','uiresume(gcbf);set(gcbo,''UserData'',1);');
dphelpctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[348.8 18.4 78.40000000000001 26.4], ...
        'String','dispprefs help', ...
        'Tag','Pushbutton1','Callback', ...
	'textbox(''dispprefs help'',help(''displayprefs''));');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[245.6 18.4 78.40000000000001 26.4], ...
        'String','Editor help', ...
        'Tag','Pushbutton1','Callback', ...
	'textbox(''dispprefs help'',help(''editdisplayprefs''));');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 142.6 125.6 16.8], ...
        'String',rframevstr, ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 118.8 125.6 16.8], ...
        'String',forceMovvstr, ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 95 125.6 16.8], ...
        'String',bgprevstr, ...
        'Style','text', ...
        'Tag','StaticText3');
h1 = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[101.6 72.80000000000001 125.6 16.8], ...
        'String',bgpostvstr, ...
        'Style','text', ...
        'Tag','StaticText3');
bgprectl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[1 1 1], ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[246.4 91.8 142.4 20], ...
        'Style','edit', ...
	'String',bgprestr, ...
        'Tag','EditText1');
bgpostctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[1 1 1], ...
        'HorizontalAlignment','left', ...
        'ListboxTop',0, ...
        'Position',[246.4 69.60000000000001 142.4 20], ...
        'Style','edit', ...
	'String',bgpoststr, ...
        'Tag','EditText1');
rframectl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Min',1, ...
        'Position',[246.4 140.2 139.2 19.2], ...
        'String',{'don''t round','do round'}, ...
        'Style','popupmenu', ...
        'Tag','PopupMenu1', ...
        'Value',rframeval);
forceMovctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Min',1, ...
        'Position',[246.4 116.4 139.2 19.2], ...
        'String',{'use defaults', 'force Movie'}, ...
        'Style','popupmenu', ...
        'Tag','PopupMenu1', ...
        'Value',forceMovval);
%h1 = uicontrol('Parent',h0, ...
%        'Units','points', ...
%        'BackgroundColor',[0.8 0.8 0.8], ...
%        'ListboxTop',0, ...
%        'Position',[392.8 234.4 79.2 19.2], ...
%        'String','change', ...
%        'Style','checkbox', ...
%	'Tag','Checkbox1');
fpsDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 212.8 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');
rectDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 190.4 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');
depthDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 166.4 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');
rframeDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 140.2 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');
forceMovDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 116.4 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');
bgpreDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 92.59999999999999 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');
bgpostDctl = uicontrol('Parent',h0, ...
        'Units','points', ...
        'BackgroundColor',[0.8 0.8 0.8], ...
        'ListboxTop',0, ...
        'Position',[392.8 70.40000000000001 79.2 19.2], ...
        'String','change', ...
        'Style','checkbox', ...
        'Tag','Checkbox1');


error_free = 0;

while ~error_free,
        drawnow;
        uiwait(h0);

 if get(cancelctl,'userdata')==1,
        error_free = 1;
 else, % it was OK

   fps = []; rect = []; depth = []; roundFrames = []; forceMovie = [];
   BGpretime = []; BGposttime = []; 
   dpStr = [];
   so = 1; % syntax_okay;
   if get(fpsDctl,'value')==1,
	try, str = get(fpsctl,'String'); fps=eval(str);
	     dpStr=[dpStr ',''fps'', ' str ];
        catch, errordlg('Syntax error in fps');so=0; end;
   end;
   if get(rectDctl,'value')==1,
	try, str = get(rectctl,'String'); rect=eval(str);
	     dpStr=[dpStr ',''rect'', ' str ];
        catch, errordlg('Syntax error in rect');so=0; end;
   end;
   if get(rframeDctl,'value')==1,
	roundFrames = get(rframectl,'value')-1;
        dpStr=[dpStr ',''roundFrames'', ' int2str(roundFrames)];
   end;
   if get(forceMovDctl,'value')==1,
	forceMovie = get(forceMovctl,'value')-1;
        dpStr=[dpStr ',''forceMovie'', ' int2str(forceMovie)];
   end;
   if get(bgpreDctl,'value')==1,
	try, str = get(bgprectl,'String'); bgpretime=eval(str);
	     dpStr=[dpStr ',''BGpretime'', ' str ];
        catch, errordlg('Syntax error in BGpretime');so=0; end;
   end;
   if get(bgpostDctl,'value')==1,
	try, str = get(bgpostctl,'String'); bgposttime=eval(str);
	     dpStr=[dpStr ',''BGposttime'', ' str ];
        catch, errordlg('Syntax error in BGposttime');so=0; end;
   end;
   if ~isempty(dpStr), dpStr = dpStr(2:end); end;
   if so, % if no syntax errors, check parameter values
	noEr = 1;
	try, eval(['testDP=displayprefs({' dpStr '});']);
        catch, errordlg(['Error: check parameters: ' lasterr]); noEr = 0; end;
        if noEr,
		error_free = 1;
		eval(['dpVal = { ' dpStr '};']);
		if outputstr, % only output a string
			dpnew = dpVal;
		else,
			dpnew = dp;
			for i=1:length(dp),
				dpnew(i) = setvalues(dp(i),dpVal);
			end;
		end;
	end;
   end;
 end;
end;
close(h0);
